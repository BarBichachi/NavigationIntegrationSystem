<?xml version="1.0" encoding="utf-8" ?>
<Page x:Class="NavigationIntegrationSystem.UI.Views.Pages.DevicesPage" xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation" xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml" xmlns:d="http://schemas.microsoft.com/expression/blend/2008" xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
      xmlns:panes="using:NavigationIntegrationSystem.UI.Views.Panes" xmlns:vm="using:NavigationIntegrationSystem.UI.ViewModels.Devices.Cards" x:Name="RootPage" mc:Ignorable="d">

    <Grid Padding="16" RowSpacing="12">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>
        <!--  Page header: title + Save devices config  -->
        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>
            <TextBlock FontSize="28" FontWeight="SemiBold" Text="Devices" />
            <Button Grid.Column="1" Command="{x:Bind ViewModel.SaveDevicesConfigCommand}" IsEnabled="{x:Bind ViewModel.CanSaveDevicesConfig, Mode=OneWay}" Style="{ThemeResource AccentButtonStyle}">
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <SymbolIcon Symbol="{x:Bind ViewModel.SaveButtonIcon, Mode=OneWay}" />
                    <TextBlock Text="{x:Bind ViewModel.SaveButtonText, Mode=OneWay}" />
                </StackPanel>
            </Button>
        </Grid>

        <!--  Main layout: devices list on the left + right pane for Settings/Inspect  -->
        <SplitView Grid.Row="1" DisplayMode="Overlay"
                   IsPaneOpen="{x:Bind ViewModel.IsPaneOpen, Mode=TwoWay}"
                   LightDismissOverlayMode="On" OpenPaneLength="520" PaneClosing="OnPaneClosing" PanePlacement="Right">

            <SplitView.Content>
                <!--  Devices list: each item is a card  -->
                <ListView ItemsSource="{x:Bind ViewModel.Devices, Mode=OneWay}" SelectionMode="None">
                    <!--  Remove default ListViewItem padding/margins so our card aligns perfectly  -->
                    <ListView.ItemContainerStyle>
                        <Style TargetType="ListViewItem">
                            <Setter Property="Padding" Value="0" />
                            <Setter Property="Margin" Value="0" />
                            <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                        </Style>
                    </ListView.ItemContainerStyle>

                    <ListView.ItemTemplate>
                        <DataTemplate x:DataType="vm:DeviceCardViewModel">
                            <!--  Device card  -->
                            <Border Margin="0,0,0,10" Padding="14"
                                    Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                    BorderThickness="1" CornerRadius="12">
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                    </Grid.RowDefinitions>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>
                                    <!--  Device identity  -->
                                    <TextBlock FontSize="18" Text="{x:Bind DisplayName}" />

                                    <!--  Runtime status (Connected/Connecting/Disconnected/Error)  -->
                                    <TextBlock Grid.Column="1" HorizontalAlignment="Right" FontSize="12" FontWeight="SemiBold"
                                               Foreground="{x:Bind Status, Mode=OneWay, Converter={StaticResource DeviceStatusToBrushConverter}}"
                                               Text="{x:Bind Status, Mode=OneWay}" />

                                    <!--  Actions row  -->
                                    <StackPanel Grid.Row="1" Grid.ColumnSpan="2" Margin="0,12,0,0" Orientation="Horizontal" Spacing="10">
                                        <!--  Connect/Disconnect (text changes based on Status)  -->
                                        <Button Command="{x:Bind ToggleConnectCommand}" IsEnabled="{x:Bind CanToggleConnect, Mode=OneWay}">
                                            <StackPanel Orientation="Horizontal" Spacing="8">
                                                <SymbolIcon Symbol="Link" />
                                                <TextBlock Text="{x:Bind ConnectButtonText, Mode=OneWay}" />
                                            </StackPanel>
                                        </Button>

                                        <!--  Open Settings pane  -->
                                        <Button Command="{x:Bind OpenSettingsCommand}" Visibility="{x:Bind ShowSettingsInspect, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
                                            <StackPanel Orientation="Horizontal" Spacing="8">
                                                <SymbolIcon Symbol="Setting" />
                                                <TextBlock Text="Settings" />
                                            </StackPanel>
                                        </Button>

                                        <!--  Open Inspect pane  -->
                                        <Button Command="{x:Bind OpenInspectCommand}" Visibility="{x:Bind ShowSettingsInspect, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
                                            <StackPanel Orientation="Horizontal" Spacing="8">
                                                <SymbolIcon Symbol="Preview" />
                                                <TextBlock Text="Inspect" />
                                            </StackPanel>
                                        </Button>
                                    </StackPanel>

                                    <!--  Inline warning when settings changed but not saved  -->
                                    <StackPanel Grid.Row="2" Grid.ColumnSpan="2" Margin="0,8,0,0" Orientation="Horizontal" Spacing="8"
                                                Visibility="{x:Bind HasUnsavedSettings, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
                                        <FontIcon Margin="0,1,0,0" Glyph="&#xE7BA;" />
                                        <TextBlock Foreground="{ThemeResource SystemFillColorCautionBrush}" Text="Settings were changed but not saved" />
                                    </StackPanel>

                                    <!--  Show last error (only when not null/empty)  -->
                                    <!--  If you already have a StringNullOrEmptyToVisibilityConverter in App.xaml, keep it; otherwise remove this block  -->
                                    <TextBlock Grid.Row="2" Grid.ColumnSpan="2" Margin="0,8,0,0" Opacity="0.85"
                                               Text="{x:Bind LastError, Mode=OneWay}"
                                               Visibility="{x:Bind LastError, Mode=OneWay, Converter={StaticResource StringNullOrEmptyToVisibilityConverter}}" />
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ListView.ItemTemplate>
                </ListView>
            </SplitView.Content>

            <SplitView.Pane>
                <!--  Right pane: header + (Settings or Inspect) + footer actions  -->
                <Grid Padding="16" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1" CornerRadius="12">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>

                    <!--  Pane header: selected device name  -->
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        <TextBlock FontSize="18" FontWeight="SemiBold" Text="{x:Bind ViewModel.SelectedDevice.DisplayName, Mode=OneWay}" />
                    </Grid>

                    <!--  Divider  -->
                    <Border Grid.Row="1" Height="1" Margin="0,12,0,12" Background="{ThemeResource CardStrokeColorDefaultBrush}" />

                    <!--  Pane content: Settings OR Inspect (visibility controlled by PaneMode converters)  -->
                    <Grid Grid.Row="2" Margin="0,0,0,12">
                        <panes:DeviceSettingsPaneView x:Name="DeviceSettingsPaneView" DataContext="{x:Bind ViewModel.CurrentSettingsPane, Mode=OneWay}" Visibility="{x:Bind ViewModel.PaneMode, Mode=OneWay, Converter={StaticResource PaneModeToSettingsVisibilityConverter}}" />
                        <panes:DeviceInspectPaneView ViewModel="{x:Bind ViewModel.SelectedDevice, Mode=OneWay}" Visibility="{x:Bind ViewModel.PaneMode, Mode=OneWay, Converter={StaticResource PaneModeToInspectVisibilityConverter}}" />
                    </Grid>

                    <!--  Pane footer: settings apply/save only when Settings is visible  -->
                    <Grid Grid.Row="3" VerticalAlignment="Bottom">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        <Button Grid.Column="1" Command="{x:Bind ViewModel.ApplySettingsCommand}" Content="Apply &amp; Save" Style="{ThemeResource AccentButtonStyle}" Visibility="{x:Bind ViewModel.PaneMode, Mode=OneWay, Converter={StaticResource PaneModeToSettingsVisibilityConverter}}" />
                    </Grid>
                </Grid>
            </SplitView.Pane>
        </SplitView>
    </Grid>
</Page>